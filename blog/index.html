<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Blog | ERPNext中文文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://erpnext.cc/blog"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | ERPNext中文文档"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://erpnext.cc/blog"><link data-rh="true" rel="alternate" href="https://erpnext.cc/blog" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://erpnext.cc/blog" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ERPNext中文文档 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ERPNext中文文档 Atom Feed">










<script src="https://hm.baidu.com/hm.js?9deb98a7ea2451b673fb3cfc9f0cc4e0" async></script>
<script src="https://erpnext.cc/js/chatbase.js" async></script>
<script src="https://www.chatbase.co/embed.min.js" id="5ZWhYlnG8H1dlLUbw4pjj" defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.600016a7.css">
<link rel="preload" href="/assets/js/runtime~main.2a140703.js" as="script">
<link rel="preload" href="/assets/js/main.d3ead1d9.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">首页</b></a><a class="navbar__item navbar__link" href="/docs/V14/">官方文档</a><a class="navbar__item navbar__link" href="/resource/">实施交付</a><a class="navbar__item navbar__link" href="/best-practice/">最佳实践</a><a class="navbar__item navbar__link" href="/business-finance-all-in-one/">业财融合</a><a class="navbar__item navbar__link" href="/resource-center/">资源中心</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">理论知识</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/computer-security/">计算机安全</a></li><li><a class="dropdown__link" href="/mes/">企业Mes系统</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="index" href="/docs/V14/">V14</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/V14/">V14</a></li><li><a class="dropdown__link" href="/docs/V13/intro">V13</a></li></ul></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/12/04/如何使用Mogodb作为后端数据库">如何使用MongoDB 作为数据库存储</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/erpnext如何与企业微信集成登录">erpnext如何与企业微信集成登录</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/覆盖Doctype的方法">覆盖Doctype的方法</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="https://frappe.io/blog/engineering/mongodb-powered-doctypes"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/12/04/如何使用Mogodb作为后端数据库">如何使用MongoDB 作为数据库存储</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-12-04T00:00:00.000Z" itemprop="datePublished">2023年12月4日</time> · <!-- -->阅读需 12 分钟</div></header><div class="markdown" itemprop="articleBody"><p><a href="https://frappe.io/blog/engineering/mongodb-powered-doctypes" target="_blank" rel="noopener noreferrer">https://frappe.io/blog/engineering/mongodb-powered-doctypes</a></p><p>在本教程中，我们将学习如何使用 MongoDB 作为 DocType 的数据源，使用 Virtual DocType 的强大功能。</p><p>2022年11月27日 · 7分钟</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="先决条件">先决条件<a href="#先决条件" class="hash-link" aria-label="先决条件的直接链接" title="先决条件的直接链接">​</a></h2><p>本教程假设您了解 Frappe 框架和 MongoDB 的基础知识。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="正常的doctypes">正常的DocTypes<a href="#正常的doctypes" class="hash-link" aria-label="正常的DocTypes的直接链接" title="正常的DocTypes的直接链接">​</a></h2><p>Frappe的Doctype类似于 Django 或类似框架中的模型。当您创建一个新的 DocType 时，在 MariaDB 数据库中创建一个新的数据库表，并且 Frappe 为您管理表和 CRUD 操作。从Desk创建 DocType 时，将在后台在相应的数据库表中插入一个新行。更新或删除文档时也是如此，Framework 负责处理数据库操作。因此，我们可以说，DocType 的后端基本上是 MariaDB (SQL)数据库中的一个表。</p><p>但是，如果我们希望 DocType 由其他数据源驱动，该怎么办呢？如果我们不希望为Mariadb创建和管理数据库表的默认行为，该怎么办？在这种情况下，我们希望控制 DocType 的数据源。这就是Virtual DocTypes发挥作用的地方。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="virtual-doctypes">Virtual DocTypes<a href="#virtual-doctypes" class="hash-link" aria-label="Virtual DocTypes的直接链接" title="Virtual DocTypes的直接链接">​</a></h2><p>Virtual DocTypes是在 Frappe 框架的13版中引入的。基本上，它使您能够控制 DocType 的完整“后端”。与普通 DocType 不同，VirtualDocType 在站点数据库中没有相应的表。作为开发人员，您必须编写代码来控制 DocType 的数据源。数据可以存在于任何地方: 一个 CSV 文件，一个基于文件的数据库(如 SQLite) ，一个成熟的数据库(如 Cassandra 或 MongoDB)。在本教程中，我们将学习如何使用 MongoDB 作为 DocType 的后端。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="设置-mongodb">设置 MongoDB<a href="#设置-mongodb" class="hash-link" aria-label="设置 MongoDB的直接链接" title="设置 MongoDB的直接链接">​</a></h2><p>在本教程中，我将使用一个永远免费的 MongoDB Atlas 实例(云上的 MongoDB) <a href="https://mongodb.com/cloud/atlas/signup" target="_blank" rel="noopener noreferrer">here</a>,  。您可以旋转一个本地实例，或者在这里创建一个空闲实例，以便跟进。</p><p>一旦你有一个工作的 MongoDB 数据库服务器，复制连接字符串，我们准备好了！</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="installing-pymongo-安装-pymongo">Installing PyMongo 安装 PyMongo<a href="#installing-pymongo-安装-pymongo" class="hash-link" aria-label="Installing PyMongo 安装 PyMongo的直接链接" title="Installing PyMongo 安装 PyMongo的直接链接">​</a></h3><p>PyMongo 是用 Python 连接和处理 MongoDB 数据库的官方 Python 驱动程序。</p><p>让我们使用以下命令在 Frappe Bench 上安装 PyMongo Python 包:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bench pip </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pymongo[srv]&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>安装完成后，我们可以打开站点的 Python 控制台，并通过连接到 MongoDB 实例来测试驱动程序。</p><p>我们可以使用以下命令打开站点控制台:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bench --site </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">site_name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> console</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>让我们连接到数据库并插入一些测试记录。我们将在 MongoDB 集合中存储有关汽车的信息。我们将数据库命名为 <code>cars-database</code> ，集合可以命名为 <code>cars</code> 。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pymongo </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MongoClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONNECTION_STRING </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;your-connection-string&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MongoClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONNECTION_STRING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;cars-database&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Get the database</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;cars&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Get the collection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Insert some test records</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cars</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">insert_many</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;make&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BMW&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;model&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;M4&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;year&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2019</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ccdeb89695&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;make&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Renault&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;model&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Kwid&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;year&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2022</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;79c1eb5a4b&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果正确地设置了数据库，并且 PyMongo 安装成功，那么上面的代码应该在没有任何错误的情况下执行。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="创建virtual-doctype">创建Virtual DocType<a href="#创建virtual-doctype" class="hash-link" aria-label="创建Virtual DocType的直接链接" title="创建Virtual DocType的直接链接">​</a></h2><p>转到 DocType 列表并创建一个新的 DocType。让我们将其命名为 <code>Car</code> ，并将模块设置为我们的自定义应用程序(在我的例子中为 <code>My Awesome App</code> )。选中 DocType 表单顶部附近的“ Is Virtual”复选框，使其成为 Virtual DocType:</p><p><img loading="lazy" src="https://frappe.io/files/doctype_form.png" alt="DocType Form View" class="img_ev3q"></p><p>其他的东西类似于任何普通的 DocType。我们将为 <code>Car</code> 文档类型创建3个字段，如下所示:</p><ol><li>Make - Data - Mandatory
强制性资料规定</li><li>Model - Data - Mandatory
模型-资料-强制性</li><li>Year - Int - Non-Negative
年-国际-非负数</li></ol><p>按下 <code>Save</code> 并导航到 <code>Car</code> 列表。正如预期的那样，该列表为空:</p><p><img loading="lazy" src="https://frappe.io/files/empty_list_view.png" alt="Empty Car List View" class="img_ev3q"></p><p>您将无法创建新文档，因为该功能不存在。我们需要编写代码来填充列表视图、创建新文档等等。好戏开始了！</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-generated-boilerplate-code-生成的样板代码">The Generated Boilerplate Code 生成的样板代码<a href="#the-generated-boilerplate-code-生成的样板代码" class="hash-link" aria-label="The Generated Boilerplate Code 生成的样板代码的直接链接" title="The Generated Boilerplate Code 生成的样板代码的直接链接">​</a></h2><p>在您选择的代码编辑器中打开您的自定义应用程序，并为 <code>Car</code> DocType 查找新生成的文件。与任何普通 DocType 一样，生成4个文件: <code>car.py</code> 、 <code>car.js</code> 、 <code>test_car.py</code> 和 <code>car.json</code> 。</p><p>打开 <code>car.py</code> 文件。您会注意到，已经为您生成了一些用于实现 Virtual DocType <code>Car</code> 的样板代码:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Car</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Document</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">db_insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load_from_db</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">db_update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@staticmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@staticmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@staticmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_stats</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这些方法必须存在于 VirtualDocType 的控制器类中。让我们从让列表视图工作开始。总的思想是从 MongoDB <code>cars</code> 集合中获取所有的汽车，并从 <code>get_list</code> 静态方法返回它:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Car</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Document</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@staticmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_cars_collection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cars_list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> car </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> cars</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cars_list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">**</span><span class="token plain">car</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">car</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cars_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Utility function to get the db collection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_cars_collection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MongoClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CONNECTION_STRING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;cars-database&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cars</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在这里，我们将获取所有的汽车，并将它们作为 Python 字典的列表返回。请注意在返回之前如何将 <code>_id</code> 字段转换为 <code>str</code> 。之所以需要这样做，是因为 <code>_id</code> 字段的类型为 <code>bson.ObjectId</code> ，这不是可序列化的 JSON。</p><p>让我们回到列表视图并刷新:</p><p><img loading="lazy" src="https://frappe.io/files/populated_list_view.png" alt="Working List View" class="img_ev3q"></p><p>瞧! 列表视图正在从 MongoDB 集合中获取数据！</p><p>尝试打开任何文档都会抛出一个错误，因为我们还没有编写代码来处理它。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="getting-a-particular-document-获取特定的文档">Getting a particular document 获取特定的文档<a href="#getting-a-particular-document-获取特定的文档" class="hash-link" aria-label="Getting a particular document 获取特定的文档的直接链接" title="Getting a particular document 获取特定的文档的直接链接">​</a></h3><p>我们需要实现以填充表单视图的方法是 <code>load_from_db</code> :</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load_from_db</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_cars_collection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    d </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cars</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_one</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Document</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里我们使用 doctype 的 <code>name</code> 字段从我们的 <code>cars</code> 集合中获取特定的文档。如果您还记得，我们在测试 PyMongo 客户机时也在插入的测试记录中添加了 name 字段。我们将使用 <code>name</code> 作为主键，而不使用 MongoDB 生成的 <code>_id</code> 字段。 <code>name</code> 字段将由 Frappe Framework 为我们自动生成，我们将在下一节中看到。</p><p>现在可以打开 <code>Car</code> 列表视图并尝试打开单个文档。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="creating-a-new-document-创建一个新文档">Creating a new document 创建一个新文档<a href="#creating-a-new-document-创建一个新文档" class="hash-link" aria-label="Creating a new document 创建一个新文档的直接链接" title="Creating a new document 创建一个新文档的直接链接">​</a></h3><p>现在，让我们实现为 <code>Car</code> DocType 创建一个新文档的功能:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">db_insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_cars_collection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    d </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_valid_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cars</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">insert_one</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>get_valid_dict</code> 方法返回文档的验证值字典。让我们检查其内容:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">&#x27;creation&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> &#x27;</span><span class="token number" style="color:#36acaa">2022</span><span class="token number" style="color:#36acaa">-11</span><span class="token number" style="color:#36acaa">-27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">28</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">48.065820</span><span class="token plain">&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;docstatus&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;idx&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;make&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> &#x27;Honda&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;model&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> &#x27;Dezire&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;modified&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> &#x27;</span><span class="token number" style="color:#36acaa">2022</span><span class="token number" style="color:#36acaa">-11</span><span class="token number" style="color:#36acaa">-27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">28</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">48.065820</span><span class="token plain">&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;modified_by&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> &#x27;Administrator&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;name&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> &#x27;c1f463ae7b&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;owner&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> &#x27;Administrator&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;year&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2022</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里我们有各种各样的字段以及我们创建的字段(make、 model 和 year)。您可以选择只在 MongoDB 实例中存储所需的字段，也可以存储以上所有字段。存储从 <code>get_valid_dict()</code> 方法返回的所有键值有其自身的好处，如自动 <code>modified</code> 和 <code>creation</code> 时间戳。我选择存储以上所有字段，因为它们是框架用来增强 doctype 的有用元数据。</p><p>现在让我们尝试创建一个新的 <code>Car</code> :</p><p><img loading="lazy" src="https://frappe.io/files/new_document.png" alt="New Car Document" class="img_ev3q"></p><p>填写详细信息并点击保存。您应该能够在 MongoDB Atlas Collection 仪表板中看到新创建的汽车:</p><p><img loading="lazy" src="https://frappe.io/files/annotated_record_in_mongodb_console.png" alt="Newly Added Record in MongoDB Atlas Dashboard" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="updating-a-document-更新文档">Updating a document 更新文档<a href="#updating-a-document-更新文档" class="hash-link" aria-label="Updating a document 更新文档的直接链接" title="Updating a document 更新文档的直接链接">​</a></h3><p>我们将需要实现 <code>db_update</code> 方法以使更新操作起作用。它也相当直截了当:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">db_update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_cars_collection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updated_values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_valid_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cars</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">update_one</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;$set&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> updated_values</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里我们再次使用 <code>get_valid_dict</code> 方法来获得所需的键-值对。现在可以尝试编辑文档并保存更改。现在应该在 MongoDB 中同步更改了！</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="deleting-a-document-删除文档">Deleting a document 删除文档<a href="#deleting-a-document-删除文档" class="hash-link" aria-label="Deleting a document 删除文档的直接链接" title="Deleting a document 删除文档的直接链接">​</a></h3><p>为了使删除文档功能正常工作，我们将实现如下所示的 <code>delete</code> 方法:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_cars_collection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cars</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delete_one</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文件计数">文件计数<a href="#文件计数" class="hash-link" aria-label="文件计数的直接链接" title="文件计数的直接链接">​</a></h3><p>列表视图显示文档的总数。我们可以通过从 <code>get_count</code> 静态方法返回该数字来提供该数字:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token decorator annotation punctuation" style="color:#393A34">@staticmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> get_cars_collection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">count_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="additional-resources-其他资源">Additional Resources 其他资源<a href="#additional-resources-其他资源" class="hash-link" aria-label="Additional Resources 其他资源的直接链接" title="Additional Resources 其他资源的直接链接">​</a></h2><p>您可以在这里找到 <code>Car</code> DocType 控制器代码的完整源代码。我还添加了一些示例代码，以使一些列表视图过滤器也能工作。</p><p>虚拟文档类型的文档是一个很好的起点。它包含了一个使用 JSON 文件作为 doctype 后端的非常好的例子。</p><p>官方的 PyMongo 文档是查找使用 PyMongo 驱动程序示例的好地方。</p><p>根据 Rushabh 在评论中提出的关于通用基类的想法，我实现了一个简单的抽象基类，它可以轻松地将任何 DocType 控制器(Virtual DocType)转换为 MongoDB 驱动的文档。你可以在这里找到密码。</p><p>使用基类，只需实现一个方法即可:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Copyright (c) 2022, Hussain and contributors</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># For license information, please see license.txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> my_awesome_app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">my_awesome_app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doctype</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">car</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">car </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MongoDBDocument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> get_mongodb_client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MongoDBDocument</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@staticmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_collection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_mongodb_client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        db </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;persons-database&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        persons </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">persons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> persons</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="in-the-end-最后">In the end 最后<a href="#in-the-end-最后" class="hash-link" aria-label="In the end 最后的直接链接" title="In the end 最后的直接链接">​</a></h2><p>一旦我们完成了实现，像 <code>frappe.get_doc</code> 和 DocTypeRESTAPI 这样的东西就可以开箱即用了！是不是很神奇！</p><p>如您所见，将 MongoDB 用作 DocType 的数据源是多么容易。您可以遵循相同的模式来连接任何其他数据库，如 Cassandra 或甚至 FirebaseFirestore。这使得 DocType 更加强大。继续，创建由您最喜欢的数据库支持的 DocType！</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="背景"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/erpnext如何与企业微信集成登录">erpnext如何与企业微信集成登录</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-11T00:00:00.000Z" itemprop="datePublished">2023年10月11日</time> · <!-- -->阅读需 2 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://erpnext.cc/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/guinanlin.png" alt="林贵南" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://erpnext.cc/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">林贵南</span></a></div><small class="avatar__subtitle" itemprop="description">顾问</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>我相信很多人都跟我类似， 对于ERPNext是否能集成企业微信感兴趣。 </p><p>下面这个地址提供了一种实现的方式。 </p><p><a href="https://github.com/saoxia/erpnext_china/blob/develop/.github/doc/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E.md" target="_blank" rel="noopener noreferrer">https://github.com/saoxia/erpnext_china/blob/develop/.github/doc/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E.md</a></p><p>我也是基于如上的内容做了相关的定制和实现， 但是实现过程做了一些微调。 下面是具体实现的效果：</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="网页登录集成">网页登录集成：<a href="#网页登录集成" class="hash-link" aria-label="网页登录集成：的直接链接" title="网页登录集成：的直接链接">​</a></h2><p>ERPNext的用户的用户名 与 企业微信的后台 的账号 是一样的。 大小写不一样关系不大。</p><p><a href="https://pic.imgdb.cn/item/6525fbcbc458853aefe1c39f.jpg" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://pic.imgdb.cn/item/6525fbcbc458853aefe1c39f.jpg" class="img_ev3q"></a></p><p>社交登录密钥的设定：</p><p><a href="https://pic.imgdb.cn/item/6525fd29c458853aefe4685b.jpg" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://pic.imgdb.cn/item/6525fd29c458853aefe4685b.jpg" class="img_ev3q"></a></p><p>企业微信后台的设定：</p><p><a href="https://pic.imgdb.cn/item/6525fe3bc458853aefe69178.jpg" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://pic.imgdb.cn/item/6525fe3bc458853aefe69178.jpg" class="img_ev3q"></a></p><p>登录效果：</p><p><a href="https://pic.imgdb.cn/item/6525fe7bc458853aefe709c0.jpg" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://pic.imgdb.cn/item/6525fe7bc458853aefe709c0.jpg" class="img_ev3q"></a></p><p><a href="https://pic.imgdb.cn/item/6525ff0fc458853aefe831a1.jpg" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://pic.imgdb.cn/item/6525ff0fc458853aefe831a1.jpg" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="在企业微信内部直接打开erpnext">在企业微信内部直接打开ERPNext<a href="#在企业微信内部直接打开erpnext" class="hash-link" aria-label="在企业微信内部直接打开ERPNext的直接链接" title="在企业微信内部直接打开ERPNext的直接链接">​</a></h2><p>方法来自于群里头的restart的分享：
<a href="https://gitee.com/sonic3k/wxwork_en/" target="_blank" rel="noopener noreferrer">https://gitee.com/sonic3k/wxwork_en/</a></p><p>对企业微信后台做配置主页：
<a href="https://pic.imgdb.cn/item/6526099ec458853aef031d4f.jpg" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://pic.imgdb.cn/item/6526099ec458853aef031d4f.jpg" class="img_ev3q"></a></p><p>具体的替换串为如下，其中xxx,yyy,zzz 替换成真实的数据
<a href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=xxx&amp;redirect_uri=yyy&amp;response_type=code&amp;scope=snsapi_base&amp;state=STATE&amp;agentid=zzz#wechat_redirect" target="_blank" rel="noopener noreferrer">https://open.weixin.qq.com/connect/oauth2/authorize?appid=xxx&amp;redirect_uri=yyy&amp;response_type=code&amp;scope=snsapi_base&amp;state=STATE&amp;agentid=zzz#wechat_redirect</a></p><p>最后实现的效果：
在PC端的界面上， 可以直接打开网页， 而无须登录。
<a href="https://pic.imgdb.cn/item/65260a3fc458853aef04fdd6.jpg" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://pic.imgdb.cn/item/65260a3fc458853aef04fdd6.jpg" class="img_ev3q"></a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/企业微信">企业微信</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/erp-next">ERPNext</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="对于那些刚接触 ERPNext 的人来说，ERPNext 是由印度软件公司 Frappe Technologies Pvt.Ltd. 开发的一个 free and open-source 的集成企业资源规划Enterprise resource planning  (ERP)软件[2\][3\] . 它基于 MariaDB 数据库系统，使用基于  Python) 的服务器端框架[4\] (source: wikipedia)"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/覆盖Doctype的方法">覆盖Doctype的方法</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-04T00:00:00.000Z" itemprop="datePublished">2023年9月4日</time> · <!-- -->阅读需 6 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://jurin.medium.com/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://miro.medium.com/v2/resize:fill:176:176/1*FIJ07tKUdYO1vKZjNOiRHw@2x.jpeg" alt="Jurin Liyun" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://jurin.medium.com/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jurin Liyun</span></a></div><small class="avatar__subtitle" itemprop="description">Developer, Trainer , Consultant, Father of two children</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>对于那些刚接触 ERPNext 的人来说，<a href="https://erpnext.com/" target="_blank" rel="noopener noreferrer"><strong>ERPNext</strong></a> 是由印度软件公司 Frappe Technologies Pvt.Ltd. 开发的一个 <a href="https://en.wikipedia.org/wiki/Free_and_open-source" target="_blank" rel="noopener noreferrer">free and open-source</a> 的集成企业资源规划<a href="https://en.wikipedia.org/wiki/Enterprise_resource_planning" target="_blank" rel="noopener noreferrer">Enterprise resource planning</a>  (ERP)软件[<a href="https://en.wikipedia.org/wiki/ERPNext#cite_note-2" target="_blank" rel="noopener noreferrer">2<!-- -->]</a>[<a href="https://en.wikipedia.org/wiki/ERPNext#cite_note-3" target="_blank" rel="noopener noreferrer">3<!-- -->]</a> . 它基于 <a href="https://en.wikipedia.org/wiki/MariaDB" target="_blank" rel="noopener noreferrer">MariaDB</a> 数据库系统，使用基于  <a href="https://en.wikipedia.org/wiki/Python_(programming_language)" target="_blank" rel="noopener noreferrer">Python</a> 的服务器端框架[<a href="https://en.wikipedia.org/wiki/ERPNext#cite_note-4" target="_blank" rel="noopener noreferrer">4<!-- -->]</a> (source: <a href="https://en.wikipedia.org/wiki/ERPNext" target="_blank" rel="noopener noreferrer">wikipedia</a>)</p><p>你可以在他们的网站上了解更多有关 ERPNext 的详情。在这篇文章中，我将试图让你了解Frappe已经提供给我们关于他们的 ERP 系统的定制。</p><p>首先，我想给出我的场景，为什么我的团队需要定制核心。</p><blockquote><p>在我工作的一个组织中，他们需要定制的工作流程来验证一个包含多个用户角色的用户，并且在这个角色中，并不是所有的用户都能以相同的批准价值来批准，即使他们被分配了相同的角色。相反，在同一个角色中，管理员可以设置他们希望允许批准的多个授权规则。</p></blockquote><p>在 ERPNext 中，有两种内置的方法可以实现这一点，即,</p><ol><li><p>Authorization Rule 授权规则</p><p>授权文档类型只允许组织设置授权销售的角色和用户。</p></li></ol><p><img loading="lazy" src="https://miro.medium.com/v2/resize:fit:700/1*egKJZn-OLgvRMrE98UPS2g.png" alt="img" class="img_ev3q"></p><ol start="2"><li>工作流程</li></ol><p>在工作流中，我们只能指定文档流在用户创建时的行为，直到销售批准为止。*</p><p><img loading="lazy" src="https://miro.medium.com/v2/resize:fit:700/1*ZVNSeQo3m8ksi62q0Zpo8g.png" alt="img" class="img_ev3q"></p><p>状态</p><p><img loading="lazy" src="https://miro.medium.com/v2/resize:fit:700/1*NsqjHmFO0PNc6F5ynO-bNQ.png" alt="img" class="img_ev3q"></p><p>规则</p><p><img loading="lazy" src="https://miro.medium.com/v2/resize:fit:700/1*NX6sdRtaWKUOpqUvUJX3XA.png" alt="img" class="img_ev3q"></p><p>规则细节。条件支持</p><p>对于许多组织来说，内置特性已经足够好了。但是，当涉及到解决某些企业组织的复杂问题时，它总是令我着迷。导致这些复杂性的原因之一，是我一直发现的管理政策的遗留问题。</p><p>我的委托人要求我的团队再做一次验证。系统应该能够满足包含角色的人员授权规则。在 ERPNext 中，我们有角色管理器，在每个角色中都包括许多人。让我为你简化一下。</p><ol><li>3个用户帐户用户的角色</li><li>用户在 A 部门工作</li><li>但并非所有具有帐户用户角色的用户都可以以相同的值进行授权。可能是授权值为10,000美元的2个用户和1个用户 $4,000。</li></ol><p>在上面的例子中，我们使用角色管理器进行了一些变通，它为不同的授权目的创建了许多不同的角色。这使得管理变得更加复杂。因此，在这种情况下，我们做另一种解决方案，仍然使用内置的，但添加另一层的授权，即“公司树”，它作为多级授权，只是为了解决组织问题。</p><p>看看我们怎么做。</p><p><img loading="lazy" src="https://miro.medium.com/v2/resize:fit:700/1*RZYJLm3q5ar8EVUH-JMNvg.png" alt="img" class="img_ev3q"></p><p>公司Doctype</p><p><img loading="lazy" src="https://miro.medium.com/v2/resize:fit:700/1*E4nlAV_HRJnwZ0ArSe4R1Q.png" alt="img" class="img_ev3q"></p><p>工作流程，文档类型，相关人员</p><p>现在让我们看看销售发票的主要文件。我们如何覆盖它并添加自定义验证。首先我们创建如下的文件目录</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">umserp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |_overrides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |_doctypes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |_sales_invoice.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from __future__ import unicode_literals</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import frappe </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import erpnext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from umserp.core.foundations.reporting import render_report</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from erpnext.accounts.doctype.sales_invoice.sales_invoice import SalesInvoice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from frappe import _</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from frappe.utils import add_days, cint, cstr, flt, formatdate, get_link_to_form, getdate, nowdate, now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from umserp.core.utils.accounting import money_to_words_malay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from umserp.umserp.doctype.module_mapper.module_mapper import validate_financial_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from umserp.umserp.doctype.company_tree.company_tree import validate_approving_tree_authority</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from frappe.model.naming import make_autoname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from erpnext.accounts.utils import get_account_currency, get_fiscal_year</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from frappe.model.workflow import get_workflow,get_transitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from frappe.query_builder import DocType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from frappe.workflow.doctype.workflow_action.workflow_action import get_doc_workflow_state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from frappe.model.workflow import get_workflow_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># sales_invoice.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class UMSSalesInvoice(SalesInvoice):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def _validate(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(UMSSalesInvoice,self).validate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.convert_amount_into_words()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if self._action == &quot;submit&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self._validate_financial_period() # this is another custom validation for financial period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self._validate_approving_tree_authority() # this is the validation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if self._validate_posting_date():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.clear_payment_schedule()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.update_posting_date()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.set_payment_schedule()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                super(UMSSalesInvoice,self).set_missing_values()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>方法 <code>self._validate_approving_tree_authority()</code> 取自公司树 doctype。这个逻辑太长了，所以我不能在这个例子中包含它。</p><p>我们使这些代码适用于 ERPNext 的最后一部分是在 <code>hook.py</code> 中包含重写类。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">override_doctype_class = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Sales Invoice&quot;: &quot;umserp.overrides.doctype.sales_invoice.UMSSalesInvoice&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在，系统会自动识别我们的代码作为首先要读取的主代码。</p><p>我在这里想说的是，ERPNext 是一个由 Frappe 框架授权的系统，可以很容易地定制，即使是一个公司可以拥有的复杂规则。当然，需求必须在一定程度上发生变化，但是如果一个框架具有这样的灵活性，那就太好了。</p><p>Happy reading. 阅读愉快。</p><p>备注:
感谢我伟大而热情的团队，使一切成为可能，而我永远不能做到没有他们。还要感谢 <a href="https://frappe.io/about" target="_blank" rel="noopener noreferrer"><em>Frappe Team</em></a> 制作了这样一个伟大的框架。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/doctype">Doctype</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/erp-next">ERPNext</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://frappeframework.com/docs/v14/user/en/introduction" target="_blank" rel="noopener noreferrer" class="footer__link-item">Frappe文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/V14/">中文文档</a></li><li class="footer__item"><a href="https://docs.erpnext.com/docs/user/manual/en/introduction" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://gitee.com/yuzelin/erpnext-chinese-docs/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">码云问题库<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discuss.frappe.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">官方社区<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">博客/代码</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://erpnext.com/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">ERPNext博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/frappe/erpnext" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tools.erpnext.cc" target="_blank" rel="noopener noreferrer" class="footer__link-item">it-tools<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2024 MIT </div></div></div></footer></div>
<script src="/assets/js/runtime~main.2a140703.js"></script>
<script src="/assets/js/main.d3ead1d9.js"></script>
</body>
</html>