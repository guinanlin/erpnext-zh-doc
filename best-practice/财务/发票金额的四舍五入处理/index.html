<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-best-practice docs-doc-id-财务/发票金额的四舍五入处理">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">发票金额的四舍五入处理 | ERPNext中文文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://erpnext.cc/best-practice/财务/发票金额的四舍五入处理"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-best-practice-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-best-practice-current"><meta data-rh="true" property="og:title" content="发票金额的四舍五入处理 | ERPNext中文文档"><meta data-rh="true" name="description" content="發票金額的四捨五入"><meta data-rh="true" property="og:description" content="發票金額的四捨五入"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://erpnext.cc/best-practice/财务/发票金额的四舍五入处理"><link data-rh="true" rel="alternate" href="https://erpnext.cc/best-practice/财务/发票金额的四舍五入处理" hreflang="en"><link data-rh="true" rel="alternate" href="https://erpnext.cc/best-practice/财务/发票金额的四舍五入处理" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ERPNext中文文档 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ERPNext中文文档 Atom Feed">








<script src="https://hm.baidu.com/hm.js?9deb98a7ea2451b673fb3cfc9f0cc4e0" async></script>
<script src="https://erpnext.cc/js/chatbase.js" async></script>
<script src="https://www.chatbase.co/embed.min.js" id="5ZWhYlnG8H1dlLUbw4pjj" defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.89c286e5.css">
<link rel="preload" href="/assets/js/runtime~main.b07b0aa0.js" as="script">
<link rel="preload" href="/assets/js/main.23b61b70.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">首页</b></a><a class="navbar__item navbar__link" href="/docs/V14/">官方文档</a><a class="navbar__item navbar__link" href="/resource/">实施交付</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/best-practice/">最佳实践</a><a class="navbar__item navbar__link" href="/business-finance-all-in-one/">业财融合</a><a class="navbar__item navbar__link" href="/resource-center/">资源中心</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="index" href="/docs/V14/">V14</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/V14/">V14</a></li><li><a class="dropdown__link" href="/docs/V13/intro">V13</a></li></ul></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/best-practice/">最佳实践</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/best-practice/安装设置/安装指南">安装设置</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/best-practice/模块理解/质量模块">模块理解</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/best-practice/应用开发/概念理解">应用开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/best-practice/调试技巧/bench execute方法">调试技巧</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/best-practice/运维保障/附件转存到NFS存储">运维保障</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/best-practice/三方集成/对接LDAP">三方集成</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/best-practice/定制开发案例/报价单界面报价金额显示数字大写">定制开发案例</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/best-practice/财务/关于会计科目本地化">财务</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/best-practice/财务/关于会计科目本地化">会计科目的本地化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/best-practice/财务/发票金额的四舍五入处理">发票金额的四舍五入处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/best-practice/财务/自定义损益表">自定义损益表</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/best-practice/财务/如何处理销售订单预收款">如何处理销售预收款问题</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/best-practice/开源/如何参与开源">开源</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">财务</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">发票金额的四舍五入处理</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>发票金额的四舍五入处理</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="發票金額的四捨五入">發票金額的四捨五入<a href="#發票金額的四捨五入" class="hash-link" aria-label="Direct link to 發票金額的四捨五入" title="Direct link to 發票金額的四捨五入">​</a></h2><p>文章来源： <a href="https://hackmd.io/@Lin301046/Sye2ylCKY" target="_blank" rel="noopener noreferrer">https://hackmd.io/@Lin301046/Sye2ylCKY</a></p><p>由於台灣的發票金額，稅費等都是整數，而 ERPNext 的金額預設都會有小數點，因此需要透過一些設定來讓 ERPNext 在計算時將金額與稅費時自行四捨五入，以符合台灣的使用習慣。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-設定-regional">1. 設定 Regional<a href="#1-設定-regional" class="hash-link" aria-label="Direct link to 1. 設定 Regional" title="Direct link to 1. 設定 Regional">​</a></h4><p>ERPNext 會根據當前的區域，若為特地區域會有不一樣的金額計算方式(<a href="https://github.com/frappe/erpnext/blob/version-13/erpnext/hooks.py#L447" target="_blank" rel="noopener noreferrer">ERPNext 的 Regionl 設定</a>)，因此我們可以按照 ERPNext 的做法，在 <a href="http://hooks.py/" target="_blank" rel="noopener noreferrer">hooks.py</a> 中新增一個 Taiwan，並且設定要 Override 的 method，如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># hooks.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">regional_overrides = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;Taiwan&#x27;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;erpnext.controllers.taxes_and_totals.get_regional_round_off_accounts&#x27;: &#x27;my_app.utils.get_regional_round_off_accounts&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># my_app.utils.get_regional_round_off_accounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def get_regional_round_off_accounts(company, account_list):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    frappe.flags.round_off_applicable_accounts = [&quot;2161 - 應付所得稅 - Company&quot;, &quot;VAT - Company&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return frappe.flags.round_off_applicable_accounts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>get_regional_round_off_accounts 中，若 accounts 的 name 存在於 frappe.flags.round_off_applicable_accounts 中，金額便會四捨五入，因此可以將需要四捨五入的 accounts 放入 round_off_applicable_accounts，如此一來在計算特定 accounts 的金額時，便都會四捨五入了</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-設定-precision">2. 設定 Precision<a href="#2-設定-precision" class="hash-link" aria-label="Direct link to 2. 設定 Precision" title="Direct link to 2. 設定 Precision">​</a></h4><p>若將 doctype 中的指定欄位精度設為 0，例如 total、amount… 也會有一樣的效果。
這部分可以利用 patch 的方式，並且透過 bench migrate 去處理，便不用每換一個環境都需要特地去執行一個 SQL。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">frappe.db.sql(f&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UPDATE `tabDocField` SET `precision` = 0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WHERE fieldname IN (&#x27;amount&#x27;, &#x27;base_amount&#x27;, &#x27;total&#x27;, &#x27;base_total&#x27;, &#x27;grand_total&#x27;, &#x27;base_grand_total&#x27;, &#x27;net_total&#x27;, &#x27;base_net_total&#x27;, &#x27;taxes_and_charges&#x27;, &#x27;base_taxes_and_charges&#x27;, &#x27;total_taxes_and_charges&#x27;) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AND (parent like &#x27;Purchase%&#x27; or parent like &#x27;Delivery%&#x27; or parent like &#x27;Sales%&#x27; or parent like &#x27;Advance%&#x27;) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AND fieldtype = &#x27;Currency&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;&quot;&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-新增欄位存放自行計算的金額與稅費">3. 新增欄位存放自行計算的金額與稅費<a href="#3-新增欄位存放自行計算的金額與稅費" class="hash-link" aria-label="Direct link to 3. 新增欄位存放自行計算的金額與稅費" title="Direct link to 3. 新增欄位存放自行計算的金額與稅費">​</a></h4><p>雖然透過前兩個方法，可以讓金額與稅費都四捨五入，但是上述兩個方法在未稅額的計算並不會起作用，因為 ERPNext 的未稅額是使用含稅額去回推的，勢必一定會出現小數點，而前面有提到，台灣的金額與稅費基本上都是整數，我們的客戶對於這部分也有特別要求一定要整數，因此在產出報表時，此情況就很容易因為四捨五入的關係而出現些微的誤差，因此為了再不影響 ERPNext 運作的前提下處理這個問題，我們選擇自行新增欄位，並且利用 Frappe 的 DocEvent，當發票新增前(before_insert)或更新前(before_save)時，先依照我們的需求去計算未稅額與稅額，之後的報表如果有需要抓未稅額的資訊時，都抓這個我們自行新增的欄位，如此便能再不影響系統運作的前提下處理好這個問題。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="python-的小數點進位">Python 的小數點進位<a href="#python-的小數點進位" class="hash-link" aria-label="Direct link to Python 的小數點進位" title="Direct link to Python 的小數點進位">​</a></h2><p>由於浮點數在電腦中是用非常近似的一個數字去表達，例如 1.5 可能會表達為 1.499999999，這個表達方式在某些數字的進位時，可能就會出現進位錯誤的情況
例如：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">round(8.125, 2) # 8.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">round(8.135, 2) # 8.13</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>8.125 四捨五入到小數點第二位應該要是 8.13，8.135 則應該要是 8.14，但是 Python 內建的 round，卻分別會是 8.12 與 8.13，因此為了解決這個問題，建議以下的方式去處理：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from frappe.utils.data import flt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flt(8.125, 2) # 8.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flt(8.135, 2) # 8.14</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 Frappe 內建的 flt 去處理進位，便不會發生這種錯誤了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cache-的應用">Cache 的應用<a href="#cache-的應用" class="hash-link" aria-label="Direct link to Cache 的應用" title="Direct link to Cache 的應用">​</a></h2><p>Frappe 已經有內建的 cache 能用，該 cache 是基於 Redis 所建立的而成的，在產生一些大型的報表時，可以將某些結果先存放於 Cache 中，以加快執行的速度。</p><p>Frappe Cache 的使用方法：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import frappe </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cache = frappe.cache()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 設定一個快取 快取的 Key 為 Cache Key , 值為 Cache Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3600 秒後過期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cache.set_value(&quot;Cache Key&quot;, &quot;Cache Value&quot;, expires_in_sec=3600)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 回傳 Cache Key 的 Value 並且不會將該值存在 frappe.local 中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 若找不到 Cache 則回傳 None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cache.get_value(cache_key, expires=True)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="www-下的頁面">www 下的頁面<a href="#www-下的頁面" class="hash-link" aria-label="Direct link to www 下的頁面" title="Direct link to www 下的頁面">​</a></h2><p>在自定義的模組下，可以按照下圖的方式去放
<img loading="lazy" src="https://i.imgur.com/lkz00oB.png" alt="img" class="img_ev3q"></p><p>這樣子就可以透過 <a href="http://127.0.0.1/sales_invoic" target="_blank" rel="noopener noreferrer">http://127.0.0.1/sales_invoic</a> 這個 URL 進入 index.html，而在進入 index.html 前，Frappe 會先執行 <a href="http://index.py/" target="_blank" rel="noopener noreferrer">index.py</a>，該 <a href="http://index.py/" target="_blank" rel="noopener noreferrer">index.py</a> 中會需要一個叫做 get_context(context) 的 method，如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># index.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def get_context(context):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.test = &#x27;Hello World&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- context 中所設定的 Hello World 會被渲染到畫面上 --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {{ test }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/html&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這個 context 會被傳到 index.html 中，並且可利用 jinja 的語法來進行使用，因此可以依照需求將需要的資料放入 context 以呈現不一樣的資訊。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-module-named-bz2">No Module Named bz2<a href="#no-module-named-bz2" class="hash-link" aria-label="Direct link to No Module Named bz2" title="Direct link to No Module Named bz2">​</a></h3><p>安裝 frappe docker 時，有可能會因為一開始編譯的 python 少了 libbz2-dev 的關係，使得 import pandas 時，會發生 No Module Named bz2 的錯誤，目前實測過後主要解決方式為安裝 libbz2-dev 後重新 build Python 即可解決。</p><p>由於 Frappe Docker 中有內建 pyenv，因此可以參考此網站的做法進行
(<a href="https://realpython.com/intro-to-pyenv/#build-dependencies" target="_blank" rel="noopener noreferrer">https://realpython.com/intro-to-pyenv/#build-dependencies</a>)</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="step1">Step1.<a href="#step1" class="hash-link" aria-label="Direct link to Step1." title="Direct link to Step1.">​</a></h4><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get install -y make build-essential libssl-dev zlib1g-dev \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="step2">Step2.<a href="#step2" class="hash-link" aria-label="Direct link to Step2." title="Direct link to Step2.">​</a></h4><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pyenv install -v &lt;Python Version&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重新安裝完之後，在安裝一次 pandas 並且 import，問題基本上就可以解決了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="form-script-沒有類似-hookspy-中的-on_update_after_submit-的事件">Form Script 沒有類似 <a href="http://hooks.py/" target="_blank" rel="noopener noreferrer">hooks.py</a> 中的 on_update_after_submit 的事件<a href="#form-script-沒有類似-hookspy-中的-on_update_after_submit-的事件" class="hash-link" aria-label="Direct link to form-script-沒有類似-hookspy-中的-on_update_after_submit-的事件" title="Direct link to form-script-沒有類似-hookspy-中的-on_update_after_submit-的事件">​</a></h2><p>由於 doc 在提交後，若要更新資料，frappe 的 form script 並沒有像後端那樣有 on_update_after_submit 的事件可以呼叫，因此無法對提交後的表單在更新前使用 JS 進行資料前處理，解決方法如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">validate_and_save(save_action, callback, btn, on_error, resolve, reject) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var me = this;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!save_action) save_action = &quot;Save&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.validate_form_action(save_action, resolve);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var after_save = function(r) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // to remove hash from URL to avoid scroll after save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            history.replaceState(null, null, &#x27; &#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(!r.exc) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ([&quot;Save&quot;, &quot;Update&quot;, &quot;Amend&quot;].indexOf(save_action)!==-1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    frappe.utils.play_sound(&quot;click&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                me.script_manager.trigger(&quot;after_save&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (frappe.route_hooks.after_save) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    let route_callback = frappe.route_hooks.after_save;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    delete frappe.route_hooks.after_save;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    route_callback(me);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // submit comment if entered</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (me.comment_box) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    me.comment_box.submit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                me.refresh();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if(on_error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    on_error();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback &amp;&amp; callback(r);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resolve();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var fail = (e) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                console.error(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            btn &amp;&amp; $(btn).prop(&quot;disabled&quot;, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(on_error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                on_error();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(save_action != &quot;Update&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            frappe.validated = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            frappe.run_serially([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                () =&gt; this.script_manager.trigger(&quot;validate&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                () =&gt; this.script_manager.trigger(&quot;before_save&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if(!frappe.validated) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        fail();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    frappe.ui.form.save(me, save_action, after_save, btn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]).catch(fail);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 修改此處的原始碼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // https://github.com/frappe/frappe/blob/version-13/frappe/public/js/frappe/form/form.js#L689</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            frappe.run_serially([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                () =&gt; this.script_manager.trigger(&quot;on_update_after_submit&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                () =&gt; frappe.ui.form.save(me, save_action, after_save, btn)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]).catch(fail)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/best-practice/财务/关于会计科目本地化"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">会计科目的本地化</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/best-practice/财务/自定义损益表"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">自定义损益表</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#發票金額的四捨五入" class="table-of-contents__link toc-highlight">發票金額的四捨五入</a></li><li><a href="#python-的小數點進位" class="table-of-contents__link toc-highlight">Python 的小數點進位</a></li><li><a href="#cache-的應用" class="table-of-contents__link toc-highlight">Cache 的應用</a></li><li><a href="#www-下的頁面" class="table-of-contents__link toc-highlight">www 下的頁面</a><ul><li><a href="#no-module-named-bz2" class="table-of-contents__link toc-highlight">No Module Named bz2</a></li></ul></li><li><a href="#form-script-沒有類似-hookspy-中的-on_update_after_submit-的事件" class="table-of-contents__link toc-highlight">Form Script 沒有類似 hooks.py 中的 on_update_after_submit 的事件</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://frappeframework.com/docs/v14/user/en/introduction" target="_blank" rel="noopener noreferrer" class="footer__link-item">Frappe文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/V14/">中文文档</a></li><li class="footer__item"><a href="https://docs.erpnext.com/docs/v14/user/manual/en/introduction" target="_blank" rel="noopener noreferrer" class="footer__link-item">英文文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://gitee.com/yuzelin/erpnext-chinese-docs/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">码云问题库<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discuss.frappe.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">官方社区<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">博客/代码</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://erpnext.com/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">ERPNext博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/frappe/erpnext" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2023 MIT </div></div></div></footer></div>
<script src="/assets/js/runtime~main.b07b0aa0.js"></script>
<script src="/assets/js/main.23b61b70.js"></script>
</body>
</html>